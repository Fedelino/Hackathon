<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AI Cooking Assistant</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="container">
    <h1>ğŸ³ AI Cooking Assistant</h1>

    <form method="POST" enctype="multipart/form-data">
        <label>Upload a food image:</label><br>
        <input type="file" name="image" accept="image/*"><br><br>

        <label>Or type your question:</label><br>
        <textarea name="prompt" rows="4"
                  placeholder="e.g., What can I cook with cheese and tomatoes?"></textarea><br><br>

        <button type="submit">Submit</button>
    </form>

    {% if ingredients %}
    <div class="section">
        <h2>ğŸ§  Detected Ingredients:</h2>
        <ul>
            {% for item in ingredients %}
            <li>{{ item }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if reply %}
    <div class="section">

        <div class="recipe-box">
            <h3 id="dish-title">{{ reply["title"] }}</h3>

            <div class="recipe-section">
                <h4>ğŸ§‚ Ingredients:</h4>
                <ul>
                    {% for item in reply["ingredients"] %}
                    <li>{{ item }}</li>
                    {% endfor %}
                </ul>
            </div>

            <div class="recipe-section">
                <h4>ğŸ“‹ Recipe Instructions:</h4>
                <ul class="no-bullets">
                    {% for item in reply["steps"] %}
                    <li>{{ item }}</li>
                    {% endfor %}
                </ul>
            </div>

            <div class="recipe-section">
                <button id="ask-ai-btn">ğŸ™ï¸ Ask the AI Assistant a Question</button>
                <audio id="response-audio" controls hidden></audio>

            </div>
        </div>
    </div>

    {% endif %}

</div>

<script>
document.getElementById("ask-ai-btn").onclick = async function () {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
    const chunks = [];

    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("audio", blob, "recording.webm");

        const response = await fetch("/listen", {
            method: "POST",
            body: formData
        });

        // Get the wav audio from the response
        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        const audioPlayer = document.getElementById("response-audio");
        audioPlayer.src = audioUrl;
        audioPlayer.hidden = false;
        audioPlayer.play();
    };

    mediaRecorder.start();

    // Stop after 5 seconds
    setTimeout(() => {
        mediaRecorder.stop();
        stream.getTracks().forEach(track => track.stop());
    }, 5000);
};
</script>


</body>
</html>